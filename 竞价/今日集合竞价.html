
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨æ•°æ®</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            font-size: 12px;
            margin: 0;
            padding: 0;
            background-color: white;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            color: #dc3545;
            margin: 4px 0;
            font-size: 18px;
            position: relative;
        }

        .header-link {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 12px;
            font-weight: normal;
            text-decoration: none;
            cursor: pointer;
        }

        .header-link:hover {
            color: #495057;
            text-decoration: underline;
        }
        
        .info-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 4px;
            margin: 0;
        }

        .info-item {
            display: inline-block;
            margin-right: 4px;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            text-align: center;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 4px;
            margin: 4px 0;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 12px;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        tbody tr {
            cursor: pointer;
        }

        tbody tr:hover {
            background-color: #d1ecf1;
        }

        .stock-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .stock-code-main {
            color: black;
        }

        .stock-code-other {
            color: #007bff;
        }

        .stock-name {
            font-weight: bold;
            color: black;
        }

        .concepts {
            color: #6c757d;
            font-size: 12px;
        }

        .board-info {
            color: #dc3545;
            font-weight: bold;
            text-align: center;
        }

        .change-percent {
            font-weight: normal;
            text-align: center;
        }

        .change-positive {
            color: #dc3545;  /* çº¢è‰² */
        }

        .change-negative {
            color: #28a745;  /* ç»¿è‰² */
        }

        .value {
            text-align: right;
            font-weight: normal;
        }

        .last-update {
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            margin: 5px 0;
        }

        .trading-status {
            text-align: center;
            font-size: 12px;
            margin: 5px 0;
            padding: 3px 4px;
            border-radius: 10px;
            display: inline-block;
            margin-left: 50%;
            transform: translateX(-50%);
        }

        .trading-active {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .trading-inactive {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .yizi-container {
            background-color: #fcb6b6;
            padding: 2px 4px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 4px;
        }

        .time-label {
            background-color: #cce7ff;
            padding: 2px 4px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 5px;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            background-color: #e9ecef;
        }

        .sort-indicator {
            margin-left: 5px;
            font-size: 12px;
            color: #6c757d;
        }
        
        /* è”åŠ¨ç›¸å…³æ ·å¼ */
        .selected-row {
            background-color: #b8daff !important;
        }
        
        .linkage-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .linkage-toast.show {
            opacity: 1;
        }
        
        .linkage-toast.success {
            background-color: #28a745;
        }
        
        .linkage-toast.error {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            ä»Šæ—¥é›†åˆç«ä»· - 15åˆ†ã€20åˆ†ã€25åˆ† å°å•ç›‘æ§            <label style="margin-right: 10px;">
                <input type="checkbox" id="tdxLinkSwitch"> é€šè¾¾ä¿¡è”åŠ¨
            </label>            <label>
                <input type="checkbox" id="thsLinkSwitch"> åŒèŠ±é¡ºè”åŠ¨
            </label>
</h1>

        <div id="info-panel" class="info-panel" style="display: none;">
            <div class="info-item"><span class="time-label">15åˆ†</span>: <span id="t15">-</span></div>
            <div class="info-item"><span class="time-label">20åˆ†</span>: <span id="t20">-</span></div>
            <div class="info-item"><span class="time-label">25åˆ†</span>: <span id="t25">-</span></div>
            <div class="info-item"><span id="th">-</span></div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <table id="stockTable" style="display: none;">
            <thead>
                <tr>
                    <th>è‚¡ç¥¨ä»£ç </th>
                    <th>è‚¡ç¥¨åç§°</th>
                    <th>æ¶¨å¹…</th>
                    <th>æ¦‚å¿µ/è¡Œä¸š</th>
                    <th>è¿æ¿</th>
                    <th class="sortable" onclick="sortTable(5)">15åˆ†<span class="sort-indicator">â†“</span></th>
                    <th class="sortable" onclick="sortTable(6)">20åˆ†<span class="sort-indicator">â†“</span></th>
                    <th class="sortable" onclick="sortTable(7)">25åˆ†<span class="sort-indicator">â†“</span></th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>

        <div id="lastUpdate" class="last-update"></div>
        <div id="tradingStatus" class="trading-status"></div>

        <!-- è”åŠ¨ç›¸å…³å…ƒç´  -->
        <div id="tdxLink" style="display: none;"></div>
        <div id="thsLink" style="display: none;"></div>
    </div>

    <script>
        let isFirstLoad = true;
        let refreshTimer = null;
        let currentData = null; // å­˜å‚¨å½“å‰æ•°æ®ç”¨äºæ’åº
        let currentSortColumn = null; // å½“å‰æ’åºåˆ—

        // æ•°æ®è·å–å’Œè§£æå‡½æ•° - æ›¿ä»£åŸæ¥çš„Pythonåç«¯é€»è¾‘
        async function fetchStockData() {
            const url = "https://duanxianxia.com/api/getFengdanLive";
            const headers = {
                "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/136.0.0.0 Safari/537.36",
                "referer": "https://duanxianxia.com/web/jjlive"
            };

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: headers,
                    timeout: 10000
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // è§£æHTMLè¡¨æ ¼
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.table, "text/html");
                const tableData = [];

                const tdElements = doc.querySelectorAll("td.fd");
                tdElements.forEach(td => {
                    const code = td.getAttribute("code") || "";

                    // è·å–è‚¡ç¥¨åç§°ï¼Œåªæå–<b>æ ‡ç­¾çš„ç›´æ¥æ–‡æœ¬ï¼Œæ’é™¤<i>æ ‡ç­¾å†…å®¹
                    let fullName = "";
                    const bTag = td.querySelector("b");
                    if (bTag) {
                        // åˆ›å»ºå‰¯æœ¬é¿å…å½±å“åŸå§‹DOM
                        const bCopy = document.createElement("b");
                        bCopy.innerHTML = bTag.innerHTML;

                        // ç§»é™¤iæ ‡ç­¾
                        const iTag = bCopy.querySelector("i");
                        if (iTag) {
                            iTag.remove();
                        }
                        fullName = bCopy.textContent.trim();
                    }

                    // ä»<i>æ ‡ç­¾ä¸­çš„<p>æ ‡ç­¾è·å–æ¦‚å¿µä¿¡æ¯
                    const concepts = [];
                    const iTag = td.querySelector("i");
                    if (iTag) {
                        const pTags = iTag.querySelectorAll("p");
                        pTags.forEach(p => {
                            concepts.push(p.textContent.trim());
                        });
                    }

                    // åˆ†ç¦»è‚¡ç¥¨åç§°å’Œæ ‡ç­¾
                    let stockName = fullName;
                    let tags = [];
                    const match = fullName.match(/^([\u4e00-\u9fff]{2,4})/);

                    if (match) {
                        stockName = match[1];
                        const remaining = fullName.substring(stockName.length);

                        if (remaining) {
                            const tagPatterns = [
                                /[\u4e00-\u9fff]+/g,  // ä¸­æ–‡è¯æ±‡
                                /\d+æ¿/g,             // æ•°å­—+æ¿
                                /[A-Za-z]+/g          // è‹±æ–‡è¯æ±‡
                            ];

                            let tempRemaining = remaining;
                            tagPatterns.forEach(pattern => {
                                const matches = tempRemaining.match(pattern);
                                if (matches) {
                                    matches.forEach(tagMatch => {
                                        if (!tags.includes(tagMatch)) {
                                            tags.push(tagMatch);
                                            tempRemaining = tempRemaining.replace(tagMatch, "");
                                        }
                                    });
                                }
                            });
                        }
                    }

                    // æå–æ‰€æœ‰spanæ ‡ç­¾
                    const allSpans = td.querySelectorAll("span");
                    const values = [];
                    let changePercent = "";

                    allSpans.forEach(span => {
                        const spanText = span.textContent.trim();
                        if (spanText.includes("%")) {
                            changePercent = spanText;
                        } else {
                            values.push(spanText);
                        }
                    });

                    // åˆ†ç¦»æ¦‚å¿µ/è¡Œä¸šå’Œè¿æ¿ä¿¡æ¯
                    let boardInfo = "";
                    let filteredConcepts = [];

                    if (concepts.length > 0) {
                        const lastConcept = concepts[concepts.length - 1];
                        if (lastConcept.includes("æ¿")) {
                            boardInfo = lastConcept;
                            filteredConcepts = concepts.slice(0, -1);
                        } else {
                            filteredConcepts = concepts;
                        }
                    }

                    // å°†è¿‡æ»¤åçš„æ¦‚å¿µ/è¡Œä¸šæ•°ç»„ç”¨é¡¿å·è¿æ¥
                    const conceptsStr = filteredConcepts.join("ã€") || "";

                    tableData.push({
                        "è‚¡ç¥¨ä»£ç ": code,
                        "è‚¡ç¥¨åç§°": stockName,
                        "æ¶¨å¹…": changePercent,
                        "æ¦‚å¿µ/è¡Œä¸š": conceptsStr,
                        "è¿æ¿": boardInfo,
                        "æ•°å€¼1": values[0] || "-",
                        "æ•°å€¼2": values[1] || "-",
                        "æ•°å€¼3": values[2] || "-"
                    });
                });

                // å¤„ç†thå­—æ®µï¼Œåªä¿ç•™spanæ ‡ç­¾ä¸­çš„å†…å®¹
                let processedTh = "";
                const thDoc = parser.parseFromString(data.th, "text/html");
                const spanTag = thDoc.querySelector("span");

                if (spanTag) {
                    processedTh = spanTag.textContent.trim();
                } else {
                    const allText = thDoc.body.textContent.replace(/\s+/g, " ").trim();
                    const match = allText.match(/ä¸€å­—:\d+ä¸ª\s*\|\s*å°å•:[\d.]+äº¿/);
                    processedTh = match ? match[0] : "";
                }

                // æ ¼å¼åŒ–è¾“å‡ºç»“æœ
                return {
                    "åŸå§‹æ•°æ®": {
                        "t15": data.t15,
                        "t20": data.t20,
                        "t25": data.t25,
                        "th": processedTh
                    },
                    "è¡¨æ ¼æ•°æ®": tableData
                };

            } catch (error) {
                return {"error": `è¯·æ±‚æˆ–è§£æå¤±è´¥: ${error.message}`};
            }
        }

        function openTdxLink(stockCode) {
            /**
             * é€šè¾¾ä¿¡è”åŠ¨å¤„ç†
             */
            console.log('é€šè¾¾ä¿¡è”åŠ¨å¤„ç†: ' + stockCode);
        }

        function saveSortState(columnIndex) {
            /**
             * ä¿å­˜æ’åºçŠ¶æ€åˆ°sessionStorageï¼ˆä»…åœ¨å½“å‰ä¼šè¯ä¸­æœ‰æ•ˆï¼‰
             */
            const sortState = {
                column: columnIndex,
                timestamp: Date.now()
            };
            sessionStorage.setItem('stockTableSort', JSON.stringify(sortState));
            currentSortColumn = columnIndex;
        }

        function loadSortState() {
            /**
             * ä»sessionStorageåŠ è½½æ’åºçŠ¶æ€
             */
            try {
                const saved = sessionStorage.getItem('stockTableSort');
                if (saved) {
                    const sortState = JSON.parse(saved);
                    return sortState.column;
                }
            } catch (e) {
                console.error('åŠ è½½æ’åºçŠ¶æ€å¤±è´¥:', e);
            }
            return null;
        }

        function updateSortIndicators(activeColumn) {
            /**
             * æ›´æ–°æ’åºæŒ‡ç¤ºå™¨æ˜¾ç¤º
             */
            // æ¸…é™¤æ‰€æœ‰æŒ‡ç¤ºå™¨
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = 'â†“';
                indicator.style.color = '#6c757d';
            });

            // é«˜äº®å½“å‰æ’åºåˆ—
            if (activeColumn !== null) {
                const headers = document.querySelectorAll('.sortable');
                headers.forEach((header, index) => {
                    if (header.getAttribute('onclick').includes(`sortTable(${activeColumn})`)) {
                        const indicator = header.querySelector('.sort-indicator');
                        if (indicator) {
                            indicator.style.color = '#007bff';
                            indicator.textContent = 'â†“';
                        }
                    }
                });
            }
        }

        function parseValue(valueStr) {
            /**
             * å°†å­—ç¬¦ä¸²æ•°å€¼è½¬æ¢ä¸ºæ•°å­—ï¼Œç”¨äºæ’åº
             * äº¿å•ä½ = æ•°å€¼ * 10000
             * ä¸‡å•ä½ = æ•°å€¼ * 1
             * "-" = 0
             */
            if (valueStr === '-' || valueStr === '') {
                return 0;
            }

            const numMatch = valueStr.match(/([\d.]+)/);
            if (!numMatch) {
                return 0;
            }

            const num = parseFloat(numMatch[1]);

            if (valueStr.includes('äº¿')) {
                return num * 10000; // äº¿è½¬æ¢ä¸ºä¸‡
            } else if (valueStr.includes('ä¸‡')) {
                return num;
            } else {
                return num;
            }
        }

        function sortTable(columnIndex) {
            /**
             * å¯¹è¡¨æ ¼è¿›è¡Œæ’åº
             * columnIndex: 5=15åˆ†, 6=20åˆ†, 7=25åˆ†
             */
            if (!currentData || !currentData.è¡¨æ ¼æ•°æ®) {
                return;
            }

            const valueKeys = ['æ•°å€¼1', 'æ•°å€¼2', 'æ•°å€¼3'];
            const valueKey = valueKeys[columnIndex - 5];

            // æŒ‰æ•°å€¼å¤§å°æ’åºï¼ˆä»å¤§åˆ°å°ï¼‰
            const sortedData = [...currentData.è¡¨æ ¼æ•°æ®].sort((a, b) => {
                const valueA = parseValue(a[valueKey]);
                const valueB = parseValue(b[valueKey]);
                return valueB - valueA; // ä»å¤§åˆ°å°
            });

            // ä¿å­˜æ’åºçŠ¶æ€
            saveSortState(columnIndex);

            // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
            updateSortIndicators(columnIndex);

            // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
            renderTable(sortedData);
        }

        function applySavedSort() {
            /**
             * åº”ç”¨ä¿å­˜çš„æ’åºçŠ¶æ€
             */
            const savedColumn = loadSortState();
            if (savedColumn !== null && currentData && currentData.è¡¨æ ¼æ•°æ®) {
                // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
                updateSortIndicators(savedColumn);
                // åº”ç”¨æ’åº
                sortTable(savedColumn);
            }
        }

        function renderTable(tableData) {
            /**
             * æ¸²æŸ“è¡¨æ ¼æ•°æ®
             */
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            tableData.forEach(row => {
                const tr = document.createElement('tr');

                // åˆ¤æ–­è‚¡ç¥¨ä»£ç é¢œè‰²
                const stockCode = row.è‚¡ç¥¨ä»£ç ;
                let stockCodeClass = 'stock-code';

                // 0æˆ–6å¼€å¤´ï¼ˆä½†ä¸æ˜¯68å¼€å¤´ï¼‰æ˜¾ç¤ºé»‘è‰²ï¼Œå…¶ä»–æ˜¾ç¤ºè“è‰²
                if (stockCode.startsWith('0') || (stockCode.startsWith('6') && !stockCode.startsWith('68'))) {
                    stockCodeClass += ' stock-code-main';
                } else {
                    stockCodeClass += ' stock-code-other';
                }

                // å¤„ç†æ¶¨å¹…é¢œè‰²
                const changePercent = row.æ¶¨å¹…;
                let changeClass = 'change-percent';
                if (changePercent && changePercent !== '-') {
                    // æå–æ•°å€¼åˆ¤æ–­æ­£è´Ÿ
                    const numMatch = changePercent.match(/([-+]?[\d.]+)%/);
                    if (numMatch) {
                        const num = parseFloat(numMatch[1]);
                        if (num > 0) {
                            changeClass += ' change-positive';  // æ­£æ•°çº¢è‰²
                        } else if (num < 0) {
                            changeClass += ' change-negative';  // è´Ÿæ•°ç»¿è‰²
                        }
                    }
                }

                tr.innerHTML = `
                    <td class="${stockCodeClass}">${row.è‚¡ç¥¨ä»£ç }</td>
                    <td class="stock-name">${row.è‚¡ç¥¨åç§°}</td>
                    <td class="${changeClass}">${changePercent || '-'}</td>
                    <td class="concepts">${row['æ¦‚å¿µ/è¡Œä¸š']}</td>
                    <td class="board-info">${row.è¿æ¿}</td>
                    <td class="value">${row.æ•°å€¼1}</td>
                    <td class="value">${row.æ•°å€¼2}</td>
                    <td class="value">${row.æ•°å€¼3}</td>
                `;

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»è¡Œæ—¶è§¦å‘è”åŠ¨å¤„ç†
                tr.addEventListener('click', function(e) {
                    handleRowClick(e);
                    handleStockClick(stockCode, row.è‚¡ç¥¨åç§°);
                });

                tableBody.appendChild(tr);
            });
        }

        async function loadData(showLoading = true) {
            const error = document.getElementById('error');
            const table = document.getElementById('stockTable');
            const infoPanel = document.getElementById('info-panel');

            // åªåœ¨é¦–æ¬¡åŠ è½½æ—¶éšè—é”™è¯¯ä¿¡æ¯
            if (showLoading && isFirstLoad) {
                error.style.display = 'none';
            }

            try {
                const data = await fetchStockData();

                if (data.error) {
                    throw new Error(data.error);
                }

                // æ›´æ–°åŸå§‹æ•°æ®ä¿¡æ¯
                document.getElementById('t15').textContent = data.åŸå§‹æ•°æ®.t15;
                document.getElementById('t20').textContent = data.åŸå§‹æ•°æ®.t20;
                document.getElementById('t25').textContent = data.åŸå§‹æ•°æ®.t25;

                // å¤„ç†thå­—æ®µï¼Œåˆ†ç¦»"ä¸€å­—"å’Œ"å°å•"ä¿¡æ¯
                const thContent = data.åŸå§‹æ•°æ®.th;
                const thElement = document.getElementById('th');

                // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†ç¦»"ä¸€å­—"å’Œ"å°å•"ä¿¡æ¯
                const yiziMatch = thContent.match(/ä¸€å­—:\d+ä¸ª/);
                const fengdanMatch = thContent.match(/å°å•:[\d.]+äº¿/);

                let formattedTh = '';
                if (yiziMatch) {
                    formattedTh += `<span class="yizi-container">${yiziMatch[0]}</span>`;
                }
                if (fengdanMatch) {
                    formattedTh += fengdanMatch[0];
                }

                thElement.innerHTML = formattedTh;
                infoPanel.style.display = 'block';

                // ä¿å­˜å½“å‰æ•°æ®
                currentData = data;

                // æ¸²æŸ“è¡¨æ ¼æ•°æ®
                renderTable(data.è¡¨æ ¼æ•°æ®);

                // åº”ç”¨ä¿å­˜çš„æ’åºçŠ¶æ€
                applySavedSort();

                table.style.display = 'table';

                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                document.getElementById('lastUpdate').textContent =
                    `æœ€åæ›´æ–°æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;

                // é¦–æ¬¡åŠ è½½å®Œæˆåï¼Œéšè—é”™è¯¯ä¿¡æ¯
                if (isFirstLoad) {
                    error.style.display = 'none';
                    isFirstLoad = false;
                }

            } catch (err) {
                // åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤ºé”™è¯¯ï¼Œåç»­é™é»˜å¤„ç†é”™è¯¯
                if (isFirstLoad) {
                    error.textContent = `åŠ è½½å¤±è´¥: ${err.message}`;
                    error.style.display = 'block';
                } else {
                    console.error('æ•°æ®åˆ·æ–°å¤±è´¥:', err.message);
                }
            }
        }

        function isInTradingTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            // æ£€æŸ¥æ˜¯å¦åœ¨9:15:00åˆ°9:30:00ä¹‹é—´
            const currentTime = hours * 3600 + minutes * 60 + seconds;
            const startTime = 9 * 3600 + 15 * 60; // 9:15:00
            const endTime = 9 * 3600 + 30 * 60;   // 9:30:00

            return currentTime >= startTime && currentTime <= endTime;
        }

        function updateTradingStatus() {
            const statusElement = document.getElementById('tradingStatus');
            const inTradingTime = isInTradingTime();

            if (inTradingTime) {
                statusElement.textContent = 'ğŸŸ¢ ç«ä»·æ—¶é—´ - æ¯5ç§’è‡ªåŠ¨åˆ·æ–°';
                statusElement.className = 'trading-status trading-active';
            } else {
                statusElement.textContent = 'ğŸ”´ éç«ä»·æ—¶é—´ - æš‚åœè‡ªåŠ¨åˆ·æ–°';
                statusElement.className = 'trading-status trading-inactive';
            }
        }

        function startRefreshTimer() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }

            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            refreshTimer = setInterval(() => {
                updateTradingStatus(); // æ›´æ–°äº¤æ˜“çŠ¶æ€æ˜¾ç¤º
                if (isInTradingTime()) {
                    // åœ¨äº¤æ˜“æ—¶é—´å†…ï¼Œæ— æ„Ÿåˆ·æ–°ï¼ˆä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼‰
                    loadData(false);
                }
            }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–æ’åºçŠ¶æ€
            currentSortColumn = loadSortState();
            updateSortIndicators(currentSortColumn);

            loadData(true); // é¦–æ¬¡åŠ è½½æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            updateTradingStatus(); // åˆå§‹åŒ–äº¤æ˜“çŠ¶æ€æ˜¾ç¤º
            startRefreshTimer(); // å¯åŠ¨å®šæ—¶åˆ·æ–°
            
            // æ·»åŠ è”åŠ¨å¼€å…³äº‹ä»¶ç›‘å¬
            const tdxSwitch = document.getElementById('tdxLinkSwitch');
            const thsSwitch = document.getElementById('thsLinkSwitch');
            
            // é€šè¾¾ä¿¡å¼€å…³äº‹ä»¶
            tdxSwitch.addEventListener('change', function() {
                if (this.checked) {
                    thsSwitch.checked = false; // å…³é—­åŒèŠ±é¡ºå¼€å…³
                }
            });
            
            // åŒèŠ±é¡ºå¼€å…³äº‹ä»¶
            thsSwitch.addEventListener('change', function() {
                console.log('THS_LINK:TOGGLE:' + this.checked);
                if (this.checked) {
                    tdxSwitch.checked = false; // å…³é—­é€šè¾¾ä¿¡å¼€å…³
                }
            });
        });

        // è”åŠ¨ç›¸å…³å‡½æ•°
        function handleRowClick(e) {
            // ç§»é™¤æ‰€æœ‰è¡Œçš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#tableBody tr').forEach(row => {
                row.classList.remove('selected-row');
            });
            
            // ä¸ºå½“å‰è¡Œæ·»åŠ é€‰ä¸­çŠ¶æ€
            const tr = e.currentTarget;
            tr.classList.add('selected-row');
        }
        
        function handleStockClick(stockCode, stockName) {
            const tdxSwitch = document.getElementById('tdxLinkSwitch');
            const thsSwitch = document.getElementById('thsLinkSwitch');
            
            console.log(`å¼€å§‹å¤„ç†è‚¡ç¥¨ç‚¹å‡»è”åŠ¨: ${stockName}(${stockCode}), é€šè¾¾ä¿¡å¼€å…³: ${tdxSwitch.checked}, åŒèŠ±é¡ºå¼€å…³: ${thsSwitch.checked}`);
            
            // è”åŠ¨é€šè¾¾ä¿¡
            if (tdxSwitch.checked) {
                try {
                    console.log('é€šè¾¾ä¿¡è”åŠ¨å¼€å…³å·²å¼€å¯ï¼Œå‘é€è”åŠ¨è¯·æ±‚');
                    
                    // ç”Ÿæˆè¯·æ±‚ID
                    const requestId = 'tdx_' + Date.now();
                    
                    // å‘é€è”åŠ¨è¯·æ±‚åˆ°Pythonç«¯
                    console.log(`TDX_LINK:STOCK:${stockCode}:${requestId}`);
                    
                    // æ˜¾ç¤ºè”åŠ¨æˆåŠŸæç¤º
                    showLinkageToast('é€šè¾¾ä¿¡è”åŠ¨æˆåŠŸ: ' + stockName + '(' + stockCode + ')\nã€å‰æï¼šè¯·æ‰“å¼€é€šè¾¾ä¿¡è½¯ä»¶ã€‘', 'success');
                    
                    // è®¾ç½®è¯·æ±‚çŠ¶æ€å’Œæ¸…ç†é€»è¾‘
                    window[requestId] = 'pending';
                    setTimeout(() => {
                        delete window[requestId];
                        console.log(`å·²æ¸…ç†é€šè¾¾ä¿¡è¯·æ±‚çŠ¶æ€: window[${requestId}]`);
                    }, 4000);
                } catch (error) {
                    // ä»…ä¿ç•™é”™è¯¯æ—¥å¿—
                    console.error('é€šè¾¾ä¿¡è”åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                }
            }
            
            // è”åŠ¨åŒèŠ±é¡º
            if (thsSwitch.checked) {
                try {
                    console.log('åŒèŠ±é¡ºè”åŠ¨å¼€å…³å·²å¼€å¯ï¼Œå‘é€è”åŠ¨è¯·æ±‚');
                    
                    // ç”Ÿæˆè¯·æ±‚ID
                    const requestId = 'ths_' + Date.now();
                    
                    // å‘é€è”åŠ¨è¯·æ±‚åˆ°Pythonç«¯
                    console.log(`THS_LINK:STOCK:${stockCode}:${requestId}`);
                    
                    // æ˜¾ç¤ºè”åŠ¨æˆåŠŸæç¤º
                    showLinkageToast('åŒèŠ±é¡ºè”åŠ¨æˆåŠŸ: ' + stockName + '(' + stockCode + ')\nã€å‰æï¼šè¯·æ‰“å¼€åŒèŠ±é¡ºè½¯ä»¶ã€‘', 'success');
                    
                    // è®¾ç½®è¯·æ±‚çŠ¶æ€å’Œæ¸…ç†é€»è¾‘
                    window[requestId] = 'pending';
                    setTimeout(() => {
                        delete window[requestId];
                        console.log(`å·²æ¸…ç†åŒèŠ±é¡ºè¯·æ±‚çŠ¶æ€: window[${requestId}]`);
                    }, 4000);
                } catch (error) {
                    // ä»…ä¿ç•™é”™è¯¯æ—¥å¿—
                    console.error('åŒèŠ±é¡ºè”åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                }
            }
            
            if (!tdxSwitch.checked && !thsSwitch.checked) {
                console.log('æ‰€æœ‰è”åŠ¨å¼€å…³æœªå¼€å¯ï¼Œè·³è¿‡è”åŠ¨æ“ä½œ');
            }
        }
        
        function showLinkageToast(message, type) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æç¤ºæ¡†ï¼Œå¦‚æœæœ‰åˆ™ç§»é™¤
            let toast = document.getElementById('linkageToast');
            if (toast) {
                document.body.removeChild(toast);
            }
            
            // åˆ›å»ºæ–°çš„æç¤ºæ¡†
            toast = document.createElement('div');
            toast.id = 'linkageToast';
            toast.className = `linkage-toast ${type}`;
            toast.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºæç¤º
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡äº¤æ˜“çŠ¶æ€æ˜¾ç¤º
        setInterval(() => {
            updateTradingStatus();
        }, 60000);
    </script>
</body>
</html>